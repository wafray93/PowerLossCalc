{% extends "base.html" %}

{% block title %}–†–∞–∑—à–∏—Ä–µ–Ω –∞–Ω–∞–ª–∏–∑{% endblock %}

{% block page_title %}<span data-lang="advancedPageTitle">–¢–µ—Ä–º–∏—á–µ–Ω –∞–Ω–∞–ª–∏–∑ –∏ —Ä–∞–∑—à–∏—Ä–µ–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</span>{% endblock %}

{% block page_description %}<span data-lang="advancedPageDescription">–†–∞–∑—à–∏—Ä–µ–Ω–∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è –≤–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ —Ç–µ—Ä–º–∏—á–µ–Ω –∞–Ω–∞–ª–∏–∑, Miller –∫–∞–ø–∞—Ü–∏—Ç–µ—Ç –∏ dead-time –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è.</span>{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.advanced-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
    margin: 20px 0;
}

.analysis-section {
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    border: 1px solid #e3e6ea;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.analysis-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.analysis-section h3 {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 1.3em;
    font-weight: 600;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
}

.input-group {
    margin-bottom: 15px;
}

.input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.input-col {
    flex: 1;
}

.input-col label {
    display: block;
    font-weight: 500;
    color: #34495e;
    margin-bottom: 5px;
    font-size: 0.9em;
}

.input-col input, .input-col select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #bdc3c7;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.input-col input:focus, .input-col select:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.canvas-container {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.canvas-container canvas {
    max-width: 100%;
    height: 300px !important;
}

.results-table {
    width: auto;
    max-width: 600px;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    font-size: 0.9em;
}

.results-table th {
    background: #34495e;
    color: white;
    padding: 8px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.85em;
}

.results-table td {
    padding: 6px 12px;
    border-bottom: 1px solid #ecf0f1;
    white-space: nowrap;
}

.results-table tr:nth-child(even) {
    background: #f8f9fa;
}

.calculate-btn {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 15px;
}

.calculate-btn:hover {
    background: linear-gradient(135deg, #2980b9, #1f5f8b);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.full-width {
    grid-column: 1 / -1;
}

.warning-box {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
    color: #856404;
}

.info-box {
    background: #d4edda;
    border: 1px solid #74c0fc;
    border-radius: 6px;
    padding: 15px;
    margin: 15px 0;
    color: #155724;
}

@media (max-width: 768px) {
    .advanced-grid {
        grid-template-columns: 1fr;
    }
    
    .input-row {
        flex-direction: column;
        gap: 10px;
    }
}

.soa-canvas-container {
    position: relative;
    height: 400px;
    margin-top: 20px;
}

.unit {
    font-size: 0.8em;
    color: #7f8c8d;
    margin-left: 5px;
}

.transistor-display {
    background: linear-gradient(145deg, #e8f4fd, #ffffff);
    border: 2px solid #3498db;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.15);
}

.transistor-display h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.2em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.transistor-display .transistor-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.transistor-display .info-item {
    background: white;
    padding: 10px 12px;
    border-radius: 6px;
    border-left: 3px solid #3498db;
    font-size: 0.9em;
}

.transistor-display .info-item strong {
    color: #2c3e50;
    display: block;
    font-size: 0.8em;
    margin-bottom: 2px;
}

.no-transistor-warning {
    background: linear-gradient(145deg, #fff3cd, #ffeaa7);
    border: 2px solid #f39c12;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 25px;
    color: #856404;
    text-align: center;
}

.no-transistor-warning .warning-title {
    font-weight: 600;
    font-size: 1.1em;
    margin-bottom: 8px;
}

.go-to-calculator-btn {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    font-size: 0.9em;
    font-weight: 500;
    cursor: pointer;
    margin-top: 10px;
    transition: all 0.3s ease;
}

.go-to-calculator-btn:hover {
    background: linear-gradient(135deg, #e67e22, #d35400);
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<!-- Transistor Information Display -->
<div id="analysisTransistorDisplay" class="transistor-display" style="display: none;">
    <h3>
        <i class="fas fa-microchip"></i>
        <span data-lang="analysisTransistorTitle">–ò–∑–ø–æ–ª–∑–≤–∞–Ω —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä –∑–∞ –∞–Ω–∞–ª–∏–∑</span>
    </h3>
    <div class="transistor-info">
        <div class="info-item">
            <strong data-lang="model">–ú–æ–¥–µ–ª:</strong>
            <span id="analysisModelName">-</span>
        </div>
        <div class="info-item">
            <strong data-lang="manufacturer">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª:</strong>
            <span id="analysisManufacturer">-</span>
        </div>
        <div class="info-item">
            <strong data-lang="package">–ö–æ—Ä–ø—É—Å:</strong>
            <span id="analysisPackage">-</span>
        </div>
        <div class="info-item">
            <strong>VDS max:</strong>
            <span id="analysisVdsMax">-</span>
        </div>
        <div class="info-item">
            <strong>ID max:</strong>
            <span id="analysisIdMax">-</span>
        </div>
        <div class="info-item">
            <strong>RDS(on):</strong>
            <span id="analysisRdsOn">-</span>
        </div>
    </div>
</div>

<!-- Warning for no transistor selected -->
<div id="noTransistorWarning" class="no-transistor-warning" style="display: none;">
    <div class="warning-title" data-lang="noTransistorSelected">‚ö†Ô∏è –ù—è–º–∞ –∏–∑–±—Ä–∞–Ω —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä –æ—Ç Calculator. –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ fallback –º–æ–¥–µ–ª –∑–∞ –∞–Ω–∞–ª–∏–∑.</div>
    <p><span data-lang="fallbackTransistorNote">–ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ fallback —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä</span>: <strong>IRFP260N (Si MOSFET)</strong></p>
    <button class="go-to-calculator-btn" onclick="showCalculatorTab()" data-lang="goToCalculator">–û—Ç–∏–¥–∏ –¥–æ Calculator</button>
</div>

<div class="advanced-grid">
    <!-- Miller Capacitance Analysis -->
    <div class="analysis-section">
        <h3 data-lang="millerCapacitance">üî¨ Miller Capacitance Analysis</h3>
        
        <div class="input-group">
            <div class="input-row">
                <div class="input-col">
                    <label for="cgd" data-lang="cgdLabel">CGD (pF):</label>
                    <input type="number" id="cgd" value="50" min="1" max="1000" step="1">
                </div>
                <div class="input-col">
                    <label for="cgs" data-lang="cgsLabel">CGS (pF):</label>
                    <input type="number" id="cgs" value="1200" min="10" max="5000" step="10">
                </div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label for="cds" data-lang="cdsLabel">CDS (pF):</label>
                    <input type="number" id="cds" value="80" min="1" max="1000" step="1">
                </div>
                <div class="input-col">
                    <label for="vdr" data-lang="vdrLabel">VDR Slew Rate (V/ns):</label>
                    <input type="number" id="vdr" value="10" min="0.1" max="100" step="0.1">
                </div>
            </div>
        </div>
        
        <button class="calculate-btn" id="calculateMillerBtn" data-lang="calculateMiller">Calculate Miller Effect</button>
        
        <div class="canvas-container">
            <canvas id="millerChart"></canvas>
        </div>
        
        <table class="results-table" id="millerResults">
            <tr><th data-lang="parameter">Parameter</th><th data-lang="value">Value</th></tr>
            <tr><td data-lang="millerMultiplier">Miller Multiplier</td><td id="millerMult">-</td></tr>
            <tr><td data-lang="effectiveCapacitance">Effective Capacitance</td><td id="effectiveCap">-</td></tr>
            <tr><td data-lang="millerCurrent">Miller Current (A)</td><td id="millerCurrent">-</td></tr>
        </table>
    </div>

    <!-- Dead-time Analysis -->
    <div class="analysis-section">
        <h3 data-lang="deadTimeAnalysis">‚ö° Dead-time Analysis</h3>
        
        <div class="input-group">
            <div class="input-row">
                <div class="input-col">
                    <label for="deadTime" data-lang="deadTimeLabel">Dead Time (ns):</label>
                    <input type="number" id="deadTime" value="100" min="10" max="2000" step="10">
                </div>
                <div class="input-col">
                    <label for="outputCurrent" data-lang="outputCurrentLabel">Output Current (A):</label>
                    <input type="number" id="outputCurrent" value="20" min="1" max="200" step="1">
                </div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label for="bodyDiodeVf" data-lang="bodyDiodeVfLabel">Body Diode Vf (V):</label>
                    <input type="number" id="bodyDiodeVf" value="0.7" min="0.3" max="2.0" step="0.1">
                </div>
                <div class="input-col">
                    <label for="switchingFreq" data-lang="switchingFreqLabel">Switching Freq (kHz):</label>
                    <input type="number" id="switchingFreq" value="50" min="1" max="500" step="1">
                </div>
            </div>
        </div>
        
        <button class="calculate-btn" id="calculateDeadTimeBtn" data-lang="calculateDeadTime">Calculate Dead-time Effects</button>
        
        <div class="canvas-container">
            <canvas id="deadTimeChart"></canvas>
        </div>
        
        <table class="results-table" id="deadTimeResults">
            <tr><th data-lang="parameter">Parameter</th><th data-lang="value">Value</th></tr>
            <tr><td data-lang="deadTimeLosses">Dead-time Losses (W)</td><td id="deadTimeLoss">-</td></tr>
            <tr><td data-lang="bodyDiodeLosses">Body Diode Losses (W)</td><td id="bodyDiodeLoss">-</td></tr>
            <tr><td data-lang="totalDeadTimeLoss">Total Dead-time Loss (W)</td><td id="totalDeadLoss">-</td></tr>
        </table>
    </div>

    <!-- Enhanced Thermal Modeling -->
    <div class="analysis-section">
        <h3 data-lang="thermalModeling">üå°Ô∏è Enhanced Thermal Modeling</h3>
        
        <div class="input-group">
            <div class="input-row">
                <div class="input-col">
                    <label for="powerLosses" data-lang="powerLossesLabel">Power Losses (W):</label>
                    <input type="number" id="powerLosses" value="25" min="0.1" max="500" step="0.1">
                </div>
                <div class="input-col">
                    <label for="ambientTemp" data-lang="ambientTempLabel">Ambient Temp (¬∞C):</label>
                    <input type="number" id="ambientTemp" value="25" min="-40" max="85" step="1">
                </div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label for="thermalResistance" data-lang="thermalResistanceLabel">Rth JC (¬∞C/W):</label>
                    <input type="number" id="thermalResistance" value="0.5" min="0.1" max="10" step="0.1">
                </div>
                <div class="input-col">
                    <label for="heatsinkRth" data-lang="heatsinkRthLabel">Heatsink Rth (¬∞C/W):</label>
                    <input type="number" id="heatsinkRth" value="2.0" min="0.1" max="50" step="0.1">
                </div>
            </div>
        </div>
        
        <button class="calculate-btn" id="calculateThermalBtn" data-lang="calculateThermal">Calculate Thermal Parameters</button>
        
        <div class="canvas-container">
            <canvas id="thermalChart"></canvas>
        </div>
        
        <table class="results-table" id="thermalResults">
            <tr><th data-lang="parameter">Parameter</th><th data-lang="value">Value</th></tr>
            <tr><td data-lang="junctionTemp">Junction Temp (¬∞C)</td><td id="tjTemp">-</td></tr>
            <tr><td data-lang="caseTemp">Case Temp (¬∞C)</td><td id="tcTemp">-</td></tr>
            <tr><td data-lang="thermalMargin">Thermal Margin (¬∞C)</td><td id="thermalMargin">-</td></tr>
            <tr><td data-lang="maxPowerDissipation">Max Power at 150¬∞C (W)</td><td id="maxPower">-</td></tr>
        </table>
    </div>

    <!-- Switching Trajectory Analysis -->
    <div class="analysis-section">
        <h3 data-lang="switchingTrajectory">üìä Switching Trajectory & SOA</h3>
        
        <div class="input-group">
            <div class="input-row">
                <div class="input-col">
                    <label for="loadInductance" data-lang="loadInductanceLabel">Load Inductance (ŒºH):</label>
                    <input type="number" id="loadInductance" value="100" min="1" max="1000" step="1">
                </div>
                <div class="input-col">
                    <label for="gateResistance" data-lang="gateResistanceLabel">Gate Resistance (Œ©):</label>
                    <input type="number" id="gateResistance" value="10" min="1" max="100" step="1">
                </div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label for="busVoltage" data-lang="busVoltageLabel">Bus Voltage (V):</label>
                    <input type="number" id="busVoltage" value="400" min="12" max="1200" step="1">
                </div>
                <div class="input-col">
                    <label for="switchingCurrent" data-lang="switchingCurrentLabel">Switching Current (A):</label>
                    <input type="number" id="switchingCurrent" value="30" min="1" max="200" step="1">
                </div>
            </div>
        </div>
        
        <button class="calculate-btn" onclick="calculateSOA()" data-lang="calculateSOA">Calculate SOA & Trajectory</button>
        
        <div class="soa-canvas-container">
            <canvas id="soaChart"></canvas>
        </div>
        
        <div class="info-box">
            <strong data-lang="soaInfo">SOA Analysis:</strong>
            <span data-lang="soaDescription">This chart shows the Safe Operating Area limits and current switching trajectory. Operating points should remain within the SOA boundaries.</span>
        </div>
    </div>

    <!-- Parasitic Effects Analysis -->
    <div class="analysis-section full-width">
        <h3 data-lang="parasiticEffects">üîß Parasitic Effects Analysis</h3>
        
        <div class="advanced-grid" style="grid-template-columns: 1fr 1fr 1fr;">
            <div class="input-group">
                <h4 data-lang="packageParasitics">Package Parasitics</h4>
                <div class="input-col">
                    <label for="packageESR" data-lang="packageESRLabel">Package ESR (mŒ©):</label>
                    <input type="number" id="packageESR" value="2" min="0.1" max="50" step="0.1">
                </div>
                <div class="input-col">
                    <label for="packageESL" data-lang="packageESLLabel">Package ESL (nH):</label>
                    <input type="number" id="packageESL" value="5" min="1" max="100" step="0.5">
                </div>
            </div>
            
            <div class="input-group">
                <h4 data-lang="pcbParasitics">PCB Parasitics</h4>
                <div class="input-col">
                    <label for="traceESR" data-lang="traceESRLabel">Trace ESR (mŒ©):</label>
                    <input type="number" id="traceESR" value="1" min="0.1" max="20" step="0.1">
                </div>
                <div class="input-col">
                    <label for="traceESL" data-lang="traceESLLabel">Trace ESL (nH):</label>
                    <input type="number" id="traceESL" value="3" min="0.5" max="50" step="0.5">
                </div>
            </div>
            
            <div class="input-group">
                <h4 data-lang="couplingEffects">Coupling Effects</h4>
                <div class="input-col">
                    <label for="mutualInductance" data-lang="mutualInductanceLabel">Mutual Inductance (nH):</label>
                    <input type="number" id="mutualInductance" value="2" min="0.1" max="20" step="0.1">
                </div>
                <div class="input-col">
                    <label for="couplingFactor" data-lang="couplingFactorLabel">Coupling Factor:</label>
                    <input type="number" id="couplingFactor" value="0.1" min="0.01" max="0.5" step="0.01">
                </div>
            </div>
        </div>
        
        <button class="calculate-btn" onclick="calculateParasitics()" data-lang="calculateParasitics">Calculate Parasitic Effects</button>
        
        <div class="advanced-grid" style="margin-top: 20px;">
            <div class="canvas-container">
                <h4 data-lang="voltageSpikeAnalysis">Voltage Spike Analysis</h4>
                <canvas id="voltageSpikesChart"></canvas>
            </div>
            <div class="canvas-container">
                <h4 data-lang="ringingAnalysis">Ringing Analysis</h4>
                <canvas id="ringingChart"></canvas>
            </div>
        </div>
        
        <table class="results-table">
            <tr><th data-lang="parameter">Parameter</th><th data-lang="value">Value</th><th data-lang="impact">Impact</th></tr>
            <tr><td data-lang="totalESR">Total ESR (mŒ©)</td><td id="totalESR">-</td><td id="esrImpact">-</td></tr>
            <tr><td data-lang="totalESL">Total ESL (nH)</td><td id="totalESL">-</td><td id="eslImpact">-</td></tr>
            <tr><td data-lang="voltageSpike">Max Voltage Spike (V)</td><td id="maxVoltageSpike">-</td><td id="spikeImpact">-</td></tr>
            <tr><td data-lang="ringingFrequency">Ringing Frequency (MHz)</td><td id="ringingFreq">-</td><td id="freqImpact">-</td></tr>
        </table>
        
        <div class="warning-box" id="parasiticWarnings" style="display: none;">
            <strong data-lang="warningsTitle">‚ö†Ô∏è Warnings:</strong>
            <div id="warningsList"></div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª–Ω–∏ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∏ –∑–∞ –≥—Ä–∞—Ñ–∏–∫–∏—Ç–µ
let millerChart, deadTimeChart, thermalChart, soaChart, voltageSpikesChart, ringingChart;

// Fallback transistor when no selectedTransistor available
const FALLBACK_TRANSISTOR = {
    name: "IRFP260N (Si MOSFET)",
    vds_max: 200,
    id_max: 50,
    rds_mohm: 40,
    tr_ns: 45,
    tf_ns: 35,
    alpha: 0.007,
    package: "TO-247",
    manufacturer: "International Rectifier",
    application: "Fallback transistor for advanced analysis"
};

// Get current transistor for analysis
function getCurrentTransistorForAnalysis() {
    // Check if selectedTransistor is available from main script
    if (window.selectedTransistor && window.selectedTransistor.name) {
        updateAnalysisDisplay(true, window.selectedTransistor);
        return window.selectedTransistor;
    }
    
    // Use fallback
    updateAnalysisDisplay(false, FALLBACK_TRANSISTOR);
    return FALLBACK_TRANSISTOR;
}

// Update the analysis display based on transistor availability
function updateAnalysisDisplay(hasSelectedTransistor, transistor) {
    const analysisDisplay = document.getElementById('analysisTransistorDisplay');
    const noTransistorWarning = document.getElementById('noTransistorWarning');
    
    if (hasSelectedTransistor) {
        if (analysisDisplay) {
            analysisDisplay.style.display = 'block';
            // Update display elements
            const modelName = document.getElementById('analysisModelName');
            const manufacturer = document.getElementById('analysisManufacturer');
            const pkg = document.getElementById('analysisPackage');
            const vdsMax = document.getElementById('analysisVdsMax');
            const idMax = document.getElementById('analysisIdMax');
            const rdsOn = document.getElementById('analysisRdsOn');
            
            if (modelName) modelName.textContent = transistor.name || '-';
            if (manufacturer) manufacturer.textContent = transistor.manufacturer || '-';
            if (pkg) pkg.textContent = transistor.package || '-';
            if (vdsMax) vdsMax.textContent = (transistor.vds_max || '-') + ' V';
            if (idMax) idMax.textContent = (transistor.id_max || '-') + ' A';
            if (rdsOn) rdsOn.textContent = (transistor.rds_mohm || '-') + ' mŒ©';
        }
        if (noTransistorWarning) noTransistorWarning.style.display = 'none';
    } else {
        if (analysisDisplay) analysisDisplay.style.display = 'none';
        if (noTransistorWarning) noTransistorWarning.style.display = 'block';
    }
}

// Function to navigate to Calculator tab
function showCalculatorTab() {
    const calculatorTab = document.querySelector('[data-target="calculator"]');
    if (calculatorTab) {
        calculatorTab.click();
    }
}

// Miller Capacitance –∞–Ω–∞–ª–∏–∑
function calculateMillerEffect() {
    const transistor = getCurrentTransistorForAnalysis();
    
    // Use transistor-specific capacitances or input values
    let cgd = parseFloat(document.getElementById('cgd').value);
    let cgs = parseFloat(document.getElementById('cgs').value);
    let cds = parseFloat(document.getElementById('cds').value);
    const vdr = parseFloat(document.getElementById('vdr').value);
    
    // Set realistic values based on transistor technology and size
    if (transistor.name.includes('GaN')) {
        // GaN transistors have much lower capacitances
        cgd = Math.min(cgd, 20); // Typical GaN CGD: 5-20pF
        cgs = Math.max(50, cgs * 0.3); // GaN CGS much lower
        cds = Math.min(cds, 30);
    } else if (transistor.name.includes('SiC')) {
        // SiC transistors moderate capacitances
        cgd = Math.min(cgd, 100); // SiC CGD typically lower
        cgs = Math.max(cgs * 0.6, 200); // SiC CGS lower than Si
    }
    
    // Adjust capacitances based on transistor current rating (larger = higher capacitance)
    const sizeFactor = Math.sqrt(transistor.id_max / 30); // Normalize to ~30A reference
    cgd *= sizeFactor;
    cgs *= sizeFactor;
    cds *= sizeFactor;
    
    // Miller multiplier calculation
    const millerMultiplier = 1 + cgd/cgs;
    const effectiveCapacitance = cgd * millerMultiplier;
    const millerCurrent = cgd * vdr * 1e-3; // Convert to amperes
    
    // Update results
    document.getElementById('millerMult').textContent = millerMultiplier.toFixed(2);
    document.getElementById('effectiveCap').textContent = effectiveCapacitance.toFixed(1) + ' pF';
    document.getElementById('millerCurrent').textContent = (millerCurrent * 1e6).toFixed(2) + ' ŒºA';
    
    // Create Miller effect chart
    const ctx = document.getElementById('millerChart').getContext('2d');
    
    if (millerChart) {
        millerChart.destroy();
    }
    
    const frequencies = [];
    const impedances = [];
    for (let f = 1; f <= 1000; f += 10) {
        frequencies.push(f);
        const omega = 2 * Math.PI * f * 1000; // Convert to Hz
        const impedance = 1 / (omega * effectiveCapacitance * 1e-12);
        impedances.push(impedance);
    }
    
    millerChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: frequencies,
            datasets: [{
                label: 'Miller Impedance (Œ©)',
                data: impedances,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Frequency (kHz)'
                    }
                },
                y: {
                    type: 'logarithmic',
                    title: {
                        display: true,
                        text: 'Impedance (Œ©)'
                    }
                }
            }
        }
    });
}

// Dead-time –∞–Ω–∞–ª–∏–∑
function calculateDeadTime() {
    const transistor = getCurrentTransistorForAnalysis();
    
    const deadTime = parseFloat(document.getElementById('deadTime').value) * 1e-9; // Convert to seconds
    const outputCurrent = parseFloat(document.getElementById('outputCurrent').value);
    let bodyDiodeVf = parseFloat(document.getElementById('bodyDiodeVf').value);
    const switchingFreq = parseFloat(document.getElementById('switchingFreq').value) * 1000; // Convert to Hz
    
    // Adjust body diode Vf based on transistor technology
    if (transistor.name.includes('SiC')) {
        bodyDiodeVf = Math.max(bodyDiodeVf, 2.5); // SiC body diodes have higher Vf
        document.getElementById('bodyDiodeVf').value = 3.2; // Update input to realistic SiC value
    } else if (transistor.name.includes('GaN')) {
        bodyDiodeVf = 5.0; // GaN typically doesn't have body diode, use external diode
        document.getElementById('bodyDiodeVf').value = 5.0;
    }
    
    // Scale dead-time recommendations based on switching speed
    const recommendedDeadTime = transistor.tr_ns + transistor.tf_ns + 20; // Add safety margin
    if (parseFloat(document.getElementById('deadTime').value) < recommendedDeadTime) {
        console.warn(`Recommended dead-time for ${transistor.name}: ${recommendedDeadTime}ns`);
    }
    
    // Dead-time losses calculation
    const deadTimeLoss = outputCurrent * bodyDiodeVf * deadTime * switchingFreq * 2; // Both transitions
    const bodyDiodeLoss = deadTimeLoss * 0.7; // Approximate body diode conduction loss
    const totalDeadLoss = deadTimeLoss + bodyDiodeLoss;
    
    // Update results
    document.getElementById('deadTimeLoss').textContent = deadTimeLoss.toFixed(2) + ' W';
    document.getElementById('bodyDiodeLoss').textContent = bodyDiodeLoss.toFixed(2) + ' W';
    document.getElementById('totalDeadLoss').textContent = totalDeadLoss.toFixed(2) + ' W';
    
    // Create dead-time chart
    const ctx = document.getElementById('deadTimeChart').getContext('2d');
    
    if (deadTimeChart) {
        deadTimeChart.destroy();
    }
    
    const deadTimes = [];
    const losses = [];
    for (let dt = 10; dt <= 500; dt += 10) {
        deadTimes.push(dt);
        const dtSec = dt * 1e-9;
        const loss = outputCurrent * bodyDiodeVf * dtSec * switchingFreq * 2;
        losses.push(loss);
    }
    
    deadTimeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: deadTimes,
            datasets: [{
                label: 'Dead-time Losses (W)',
                data: losses,
                borderColor: '#f39c12',
                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Dead Time (ns)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Losses (W)'
                    }
                }
            }
        }
    });
}

// Enhanced Thermal –∞–Ω–∞–ª–∏–∑
function calculateThermal() {
    const powerLosses = parseFloat(document.getElementById('powerLosses').value);
    const ambientTemp = parseFloat(document.getElementById('ambientTemp').value);
    const thermalResistance = parseFloat(document.getElementById('thermalResistance').value);
    const heatsinkRth = parseFloat(document.getElementById('heatsinkRth').value);
    
    // Thermal calculations
    const totalRth = thermalResistance + heatsinkRth;
    const junctionTemp = ambientTemp + (powerLosses * totalRth);
    const caseTemp = ambientTemp + (powerLosses * heatsinkRth);
    const thermalMargin = 150 - junctionTemp; // Assuming 150¬∞C max junction temp
    const maxPowerAt150C = (150 - ambientTemp) / totalRth;
    
    // Update results
    document.getElementById('tjTemp').textContent = junctionTemp.toFixed(1) + '¬∞C';
    document.getElementById('tcTemp').textContent = caseTemp.toFixed(1) + '¬∞C';
    document.getElementById('thermalMargin').textContent = thermalMargin.toFixed(1) + '¬∞C';
    document.getElementById('maxPower').textContent = maxPowerAt150C.toFixed(1) + ' W';
    
    // Create thermal chart
    const ctx = document.getElementById('thermalChart').getContext('2d');
    
    if (thermalChart) {
        thermalChart.destroy();
    }
    
    const powers = [];
    const junctionTemps = [];
    for (let p = 0; p <= 100; p += 2) {
        powers.push(p);
        const tj = ambientTemp + (p * totalRth);
        junctionTemps.push(tj);
    }
    
    thermalChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: powers,
            datasets: [{
                label: 'Junction Temperature (¬∞C)',
                data: junctionTemps,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Power Dissipation (W)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Junction Temperature (¬∞C)'
                    }
                }
            },
            plugins: {
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: 150,
                            yMax: 150,
                            borderColor: 'red',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: 'Max Junction Temp',
                                enabled: true
                            }
                        }
                    }
                }
            }
        }
    });
}

// Safe Operating Area –∞–Ω–∞–ª–∏–∑
function calculateSOA() {
    const transistor = getCurrentTransistorForAnalysis();
    
    const loadInductance = parseFloat(document.getElementById('loadInductance').value) * 1e-6; // Convert to H
    const gateResistance = parseFloat(document.getElementById('gateResistance').value);
    const busVoltage = parseFloat(document.getElementById('busVoltage').value);
    const switchingCurrent = parseFloat(document.getElementById('switchingCurrent').value);
    
    // SOA boundaries based on selected transistor
    const maxContinuousCurrent = transistor.id_max * 0.8; // 80% derating for continuous
    const maxVoltage = transistor.vds_max * 0.9; // 90% derating for safety
    const maxPulseCurrent = transistor.id_max * 3; // Typical pulse current capability
    const thermalLimit = calculateThermalLimitPower(transistor); // Dynamic thermal limit
    
    // Check if operating point is safe
    const voltageSafety = busVoltage / maxVoltage;
    const currentSafety = switchingCurrent / maxContinuousCurrent;
    
    if (voltageSafety > 0.9) {
        console.warn(`Operating voltage (${busVoltage}V) is ${(voltageSafety*100).toFixed(0)}% of transistor limit`);
    }
    if (currentSafety > 0.9) {
        console.warn(`Operating current (${switchingCurrent}A) is ${(currentSafety*100).toFixed(0)}% of transistor limit`);
    }
    
    // Create SOA chart
    const ctx = document.getElementById('soaChart').getContext('2d');
    
    if (soaChart) {
        soaChart.destroy();
    }
    
    // SOA boundary points
    const soaBoundaryVoltages = [0, busVoltage, maxVoltage, maxVoltage, 0, 0];
    const soaBoundaryCurrents = [maxPulseCurrent, thermalLimit/busVoltage, thermalLimit/maxVoltage, 0, 0, maxPulseCurrent];
    
    // Operating point
    const operatingVoltage = busVoltage;
    const operatingCurrent = switchingCurrent;
    
    soaChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'SOA Boundary',
                data: soaBoundaryVoltages.map((v, i) => ({x: v, y: soaBoundaryCurrents[i]})),
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                showLine: true,
                fill: true
            }, {
                label: 'Operating Point',
                data: [{x: operatingVoltage, y: operatingCurrent}],
                borderColor: '#2ecc71',
                backgroundColor: '#2ecc71',
                pointRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Voltage (V)'
                    },
                    min: 0
                },
                y: {
                    title: {
                        display: true,
                        text: 'Current (A)'
                    },
                    min: 0
                }
            }
        }
    });
}

// Parasitic Effects –∞–Ω–∞–ª–∏–∑
function calculateParasitics() {
    const transistor = getCurrentTransistorForAnalysis();
    
    let packageESR = parseFloat(document.getElementById('packageESR').value) * 1e-3; // Convert to ohms
    let packageESL = parseFloat(document.getElementById('packageESL').value) * 1e-9; // Convert to H
    const traceESR = parseFloat(document.getElementById('traceESR').value) * 1e-3;
    const traceESL = parseFloat(document.getElementById('traceESL').value) * 1e-9;
    const mutualInductance = parseFloat(document.getElementById('mutualInductance').value) * 1e-9;
    const couplingFactor = parseFloat(document.getElementById('couplingFactor').value);
    
    // Adjust parasitics based on package type
    const packageParasitics = getPackageParasitics(transistor.package);
    packageESR = packageParasitics.esr * 1e-3;
    packageESL = packageParasitics.esl * 1e-9;
    
    // Update input fields to show realistic values
    document.getElementById('packageESR').value = (packageESR * 1e3).toFixed(1);
    document.getElementById('packageESL').value = (packageESL * 1e9).toFixed(1);
    
    // Calculate totals
    const totalESR = (packageESR + traceESR) * 1e3; // Convert back to mŒ© for display
    const totalESL = (packageESL + traceESL) * 1e9; // Convert back to nH for display
    
    // Voltage spike calculation (simplified)
    const diDt = 1e9; // A/s (typical fast switching)
    const maxVoltageSpike = (packageESL + traceESL) * diDt;
    
    // Ringing frequency
    const totalCapacitance = 1e-9; // Assume 1nF total capacitance
    const ringingFreq = 1 / (2 * Math.PI * Math.sqrt((packageESL + traceESL) * totalCapacitance)) / 1e6; // Convert to MHz
    
    // Update results
    document.getElementById('totalESR').textContent = totalESR.toFixed(1) + ' mŒ©';
    document.getElementById('totalESL').textContent = totalESL.toFixed(1) + ' nH';
    document.getElementById('maxVoltageSpike').textContent = maxVoltageSpike.toFixed(1) + ' V';
    document.getElementById('ringingFreq').textContent = ringingFreq.toFixed(1) + ' MHz';
    
    // Impact assessment
    document.getElementById('esrImpact').textContent = totalESR > 10 ? 'High' : totalESR > 5 ? 'Medium' : 'Low';
    document.getElementById('eslImpact').textContent = totalESL > 20 ? 'High' : totalESL > 10 ? 'Medium' : 'Low';
    document.getElementById('spikeImpact').textContent = maxVoltageSpike > 50 ? 'High' : maxVoltageSpike > 20 ? 'Medium' : 'Low';
    document.getElementById('freqImpact').textContent = ringingFreq > 100 ? 'High' : ringingFreq > 50 ? 'Medium' : 'Low';
    
    // Create voltage spikes chart
    const ctx1 = document.getElementById('voltageSpikesChart').getContext('2d');
    
    if (voltageSpikesChart) {
        voltageSpikesChart.destroy();
    }
    
    // Generate voltage spike waveform
    const timePoints = [];
    const voltagePoints = [];
    for (let t = 0; t <= 100; t += 1) {
        timePoints.push(t);
        const voltage = maxVoltageSpike * Math.exp(-t/20) * Math.sin(2*Math.PI*ringingFreq*t*1e-9*1e6);
        voltagePoints.push(voltage);
    }
    
    voltageSpikesChart = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: timePoints,
            datasets: [{
                label: 'Voltage Spike (V)',
                data: voltagePoints,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time (ns)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Voltage (V)'
                    }
                }
            }
        }
    });
    
    // Create ringing analysis chart
    const ctx2 = document.getElementById('ringingChart').getContext('2d');
    
    if (ringingChart) {
        ringingChart.destroy();
    }
    
    // Generate ringing frequency response
    const frequencies = [];
    const impedances = [];
    for (let f = 1; f <= 1000; f += 10) {
        frequencies.push(f);
        const omega = 2 * Math.PI * f * 1e6; // Convert MHz to rad/s
        const impedance = Math.sqrt(Math.pow(totalESR*1e-3, 2) + Math.pow(omega * totalESL*1e-9, 2));
        impedances.push(impedance * 1000); // Convert to mŒ©
    }
    
    ringingChart = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: frequencies,
            datasets: [{
                label: 'Impedance (mŒ©)',
                data: impedances,
                borderColor: '#f39c12',
                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Frequency (MHz)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Impedance (mŒ©)'
                    }
                }
            }
        }
    });
    
    // Show warnings if needed
    let warnings = [];
    if (totalESR > 10) warnings.push('High ESR may cause excessive losses');
    if (totalESL > 20) warnings.push('High ESL may cause voltage spikes');
    if (maxVoltageSpike > 50) warnings.push('Voltage spikes may exceed device ratings');
    if (ringingFreq < 10) warnings.push('Low ringing frequency may cause EMI issues');
    
    if (warnings.length > 0) {
        document.getElementById('parasiticWarnings').style.display = 'block';
        document.getElementById('warningsList').innerHTML = warnings.map(w => `<div>‚Ä¢ ${w}</div>`).join('');
    } else {
        document.getElementById('parasiticWarnings').style.display = 'none';
    }
}

// Initialize calculations on page load
document.addEventListener('DOMContentLoaded', function() {
    calculateMillerEffect();
    calculateDeadTime();
    calculateThermal();
    calculateSOA();
    calculateParasitics();
});
// Helper function to calculate thermal limit based on transistor
function calculateThermalLimitPower(transistor) {
    // Estimate thermal limit based on package and RDS(on)
    const packageThermalMap = {
        'TO-220': 62.5, // TO-220 typical Rth_ja
        'TO-247': 40,   // TO-247 better thermal
        'TO-263': 50,   // D2PAK
        'SOT-227': 35,  // Better thermal for high power
        'default': 50
    };
    
    const rthJA = packageThermalMap[transistor.package] || packageThermalMap.default;
    const maxJunctionTemp = 150; // Typical max
    const ambientTemp = 25;
    
    return (maxJunctionTemp - ambientTemp) / rthJA;
}

// Helper function to get package parasitics
function getPackageParasitics(packageType) {
    const packageMap = {
        'TO-220': { esr: 3, esl: 8 },
        'TO-247': { esr: 2, esl: 5 },
        'TO-263': { esr: 2.5, esl: 6 },
        'SOT-227': { esr: 1.5, esl: 4 },
        'QFN': { esr: 1, esl: 2 },
        'BGA': { esr: 0.5, esl: 1 },
        'default': { esr: 2.5, esl: 6 }
    };
    
    return packageMap[packageType] || packageMap.default;
}

// Initialize display on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initial update of transistor display
    updateAnalysisDisplay(false, FALLBACK_TRANSISTOR);
    
    // Check periodically for selectedTransistor updates
    setInterval(function() {
        if (window.selectedTransistor && window.selectedTransistor !== getCurrentTransistorForAnalysis()) {
            getCurrentTransistorForAnalysis(); // This will update the display
        }
    }, 1000);
});

</script>
{% endblock %}