{% extends "base.html" %}

{% block title %}–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏{% endblock %}

{% block page_title %}<span data-lang="toolsTitle">–ü–æ–º–æ—â–Ω–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</span>{% endblock %}

{% block page_description %}<span data-lang="toolsDescription">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ –∫–æ–ø–∏—Ä–∞–Ω–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –µ–¥–∏–Ω–∏—Ü–∏ –∏ –µ–∫—Å–ø–æ—Ä—Ç –Ω–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –Ω–∞—É—á–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.</span>{% endblock %}

{% block content %}
<section class="tools-content">
    <!-- Selected Transistor Integration -->
    <div class="selected-transistor-tools" id="selectedTransistorTools" style="display: none;">
        <div class="tools-transistor-header">
            <h3>üéØ <span data-lang="toolsForSelectedTransistor">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ –∏–∑–±—Ä–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä</span></h3>
            <div class="tools-transistor-info">
                <span id="toolsTransistorName">-</span> ‚Ä¢ 
                <span id="toolsTransistorVds">-</span>V ‚Ä¢ 
                <span id="toolsTransistorRds">-</span>mŒ©
            </div>
            <button id="goToCalculatorFromTools" class="btn-primary">
                üìä <span data-lang="goToCalculator">–û—Ç–∏–¥–∏ –≤ –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞</span>
            </button>
        </div>
    </div>
    
    <div class="no-transistor-tools-warning" id="noTransistorToolsWarning">
        <div class="tools-warning-content">
            ‚ö†Ô∏è <span data-lang="noTransistorForTools">–ó–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è, –∏–∑–±–µ—Ä–µ—Ç–µ —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä –æ—Ç –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä–∞.</span>
            <button id="selectTransistorFromTools" class="btn-secondary">
                üßÆ <span data-lang="selectTransistor">–ò–∑–±–µ—Ä–∏ —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä</span>
            </button>
        </div>
    </div>
    
    <!-- Chart Copying Tools -->
    <div class="controls tool-section">
        <h2><span data-lang="chartCopyTitle">üìã –ö–æ–ø–∏—Ä–∞–Ω–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∏</span></h2>
        <p><span data-lang="chartCopyDescription">–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π—Ç–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å –≤–∏—Å–æ–∫–∞ —Ä–µ–∑–æ–ª—é—Ü–∏—è –∑–∞ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏.</span></p>
        
        <div class="chart-export-controls">
            <div class="input-group">
                <span data-lang="qualitySettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ –∫–∞—á–µ—Å—Ç–≤–æ:</span>
                <select id="exportQuality">
                    <option value="300" data-lang="dpi300">300 DPI (Print)</option>
                    <option value="150" data-lang="dpi150">150 DPI (Screen)</option>
                    <option value="72" data-lang="dpi72">72 DPI (Web)</option>
                </select>
            </div>
            
            <div class="button-row">
                <button onclick="exportChart('png')" class="export-btn">
                    üìä <span data-lang="exportPNG">–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π –∫–∞—Ç–æ PNG</span>
                </button>
                <button onclick="exportChart('svg')" class="export-btn">
                    üé® <span data-lang="exportSVG">–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π –∫–∞—Ç–æ SVG</span>
                </button>
                <button onclick="copyChartToClipboard()" class="export-btn">
                    üìã <span data-lang="copyToClipboard">–ö–æ–ø–∏—Ä–∞–π –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞</span>
                </button>
            </div>
            
            <div id="chartExportStatus" class="status-message"></div>
        </div>
    </div>

    <!-- Unit Converter -->
    <div class="controls tool-section">
        <h2><span data-lang="unitConverterTitle">üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–æ—Ä –Ω–∞ –µ–¥–∏–Ω–∏—Ü–∏</span></h2>
        <p><span data-lang="unitConverterDescription">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–π—Ç–µ –º–µ–∂–¥—É —Ä–∞–∑–ª–∏—á–Ω–∏ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∏ –µ–¥–∏–Ω–∏—Ü–∏.</span></p>
        
        <div class="unit-converter">
            <div class="converter-grid">
                <!-- Voltage Converter -->
                <div class="converter-section">
                    <h4>‚ö° –ù–∞–ø—Ä–µ–∂–µ–Ω–∏–µ</h4>
                    <div class="converter-inputs">
                        <input type="number" id="voltageInput" placeholder="0" step="any">
                        <select id="voltageFrom">
                            <option value="V">V (Volt)</option>
                            <option value="kV">kV (Kilovolt)</option>
                            <option value="mV">mV (Millivolt)</option>
                            <option value="ŒºV">ŒºV (Microvolt)</option>
                        </select>
                        <span>‚Üí</span>
                        <select id="voltageTo">
                            <option value="V">V (Volt)</option>
                            <option value="kV">kV (Kilovolt)</option>
                            <option value="mV">mV (Millivolt)</option>
                            <option value="ŒºV">ŒºV (Microvolt)</option>
                        </select>
                        <span id="voltageResult" class="result">-</span>
                    </div>
                </div>

                <!-- Current Converter -->
                <div class="converter-section">
                    <h4>üîå –¢–æ–∫</h4>
                    <div class="converter-inputs">
                        <input type="number" id="currentInput" placeholder="0" step="any">
                        <select id="currentFrom">
                            <option value="A">A (Ampere)</option>
                            <option value="kA">kA (Kiloampere)</option>
                            <option value="mA">mA (Milliampere)</option>
                            <option value="ŒºA">ŒºA (Microampere)</option>
                        </select>
                        <span>‚Üí</span>
                        <select id="currentTo">
                            <option value="A">A (Ampere)</option>
                            <option value="kA">kA (Kiloampere)</option>
                            <option value="mA">mA (Milliampere)</option>
                            <option value="ŒºA">ŒºA (Microampere)</option>
                        </select>
                        <span id="currentResult" class="result">-</span>
                    </div>
                </div>

                <!-- Resistance Converter -->
                <div class="converter-section">
                    <h4>‚ö° –°—ä–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</h4>
                    <div class="converter-inputs">
                        <input type="number" id="resistanceInput" placeholder="0" step="any">
                        <select id="resistanceFrom">
                            <option value="Œ©">Œ© (Ohm)</option>
                            <option value="kŒ©">kŒ© (Kiloohm)</option>
                            <option value="mŒ©">mŒ© (Milliohm)</option>
                            <option value="MŒ©">MŒ© (Megaohm)</option>
                        </select>
                        <span>‚Üí</span>
                        <select id="resistanceTo">
                            <option value="Œ©">Œ© (Ohm)</option>
                            <option value="kŒ©">kŒ© (Kiloohm)</option>
                            <option value="mŒ©">mŒ© (Milliohm)</option>
                            <option value="MŒ©">MŒ© (Megaohm)</option>
                        </select>
                        <span id="resistanceResult" class="result">-</span>
                    </div>
                </div>

                <!-- Temperature Converter -->
                <div class="converter-section">
                    <h4>üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h4>
                    <div class="converter-inputs">
                        <input type="number" id="temperatureInput" placeholder="0" step="any">
                        <select id="temperatureFrom">
                            <option value="¬∞C">¬∞C (Celsius)</option>
                            <option value="K">K (Kelvin)</option>
                            <option value="¬∞F">¬∞F (Fahrenheit)</option>
                        </select>
                        <span>‚Üí</span>
                        <select id="temperatureTo">
                            <option value="¬∞C">¬∞C (Celsius)</option>
                            <option value="K">K (Kelvin)</option>
                            <option value="¬∞F">¬∞F (Fahrenheit)</option>
                        </select>
                        <span id="temperatureResult" class="result">-</span>
                    </div>
                </div>
            </div>
            
            <div class="button-row">
                <button onclick="clearAllConversions()" class="utility-btn">
                    üóëÔ∏è <span data-lang="clearConversion">–ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–∏</span>
                </button>
            </div>
        </div>
    </div>

    <!-- CSV Import/Export -->
    <div class="controls tool-section">
        <h2><span data-lang="csvImportExportTitle">üìÇ CSV –ò–º–ø–æ—Ä—Ç/–ï–∫—Å–ø–æ—Ä—Ç</span></h2>
        <p><span data-lang="csvImportExportDescription">–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–π—Ç–µ —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä–Ω–∏ –¥–∞–Ω–Ω–∏ –∏–ª–∏ –µ–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.</span></p>
        
        <div class="csv-tools">
            <div class="csv-import-section">
                <h4><span data-lang="importTransistorData">–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–π —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä–Ω–∏ –¥–∞–Ω–Ω–∏</span></h4>
                <div class="file-upload-area">
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                    <div class="upload-button" onclick="document.getElementById('csvFileInput').click()">
                        üìÅ <span data-lang="importCSV">–ò–∑–±–µ—Ä–µ—Ç–µ CSV —Ñ–∞–π–ª</span>
                    </div>
                    <div id="csvImportStatus" class="status-message"></div>
                </div>
                
                <div class="csv-format-info">
                    <small>Format: model,technology,vds_max,id_max,rds_mohm,tr_ns,tf_ns,alpha,package,manufacturer,application</small>
                </div>
            </div>
            
            <div class="csv-export-section">
                <h4><span data-lang="exportResults">–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</span></h4>
                <div class="button-row">
                    <button onclick="exportCalculationsToCSV()" class="export-btn">
                        üíæ <span data-lang="downloadCSV">–°–≤–∞–ª–∏ CSV —Ñ–∞–π–ª</span>
                    </button>
                    <button onclick="exportCalculationsToPDF()" class="export-btn">
                        üìä <span data-lang="downloadPDF">–°–≤–∞–ª–∏ PDF –æ—Ç—á–µ—Ç</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Parameter Calculator -->
    <div class="controls tool-section">
        <h2><span data-lang="paramCalculatorTitle">üßÆ –ö–∞–ª–∫—É–ª–∞—Ç–æ—Ä –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</span></h2>
        <p><span data-lang="paramCalculatorDescription">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –æ–ø—Ç–∏–º–∞–ª–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏.</span></p>
        
        <div class="parameter-calculator">
            <div class="transistor-integration" id="transistorIntegration" style="display: none;">
                <div class="integration-info">
                    <h4>üéØ <span data-lang="usingSelectedTransistor">–ò–∑–ø–æ–ª–∑–≤–∞ –∏–∑–±—Ä–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä:</span></h4>
                    <div class="integration-details">
                        <span id="integrationTransistorName">-</span> ‚Ä¢ 
                        VDS: <span id="integrationVds">-</span>V ‚Ä¢ 
                        RDS: <span id="integrationRds">-</span>mŒ©
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <span data-lang="powerRating">–ù–æ–º–∏–Ω–∞–ª–Ω–∞ –º–æ—â–Ω–æ—Å—Ç (W):</span>
                <input type="number" id="targetPower" placeholder="100" step="any">
            </div>
            
            <div class="input-group">
                <span data-lang="voltageRating">–ù–æ–º–∏–Ω–∞–ª–Ω–æ –Ω–∞–ø—Ä–µ–∂–µ–Ω–∏–µ (V):</span>
                <input type="number" id="targetVoltage" placeholder="400" step="any">
                <small id="voltageHint" style="display: none;">–ü—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ: –ø–æ–¥ <span id="safeVoltage">-</span>V (60% –æ—Ç VDS max)</small>
            </div>
            
            <div class="input-group">
                <span data-lang="currentRating">–ù–æ–º–∏–Ω–∞–ª–µ–Ω —Ç–æ–∫ (A):</span>
                <input type="number" id="targetCurrent" placeholder="10" step="any">
                <small id="currentHint" style="display: none;">–ü—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ: –ø–æ–¥ <span id="safeCurrent">-</span>A (70% –æ—Ç ID max)</small>
            </div>
            
            <div class="button-row">
                <button onclick="calculateOptimalParameters()" class="calculate-btn">
                    üßÆ <span data-lang="calculateOptimal">–ò–∑—á–∏—Å–ª–∏ –æ–ø—Ç–∏–º–∞–ª–Ω–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</span>
                </button>
                <button onclick="suggestTransistors()" class="suggest-btn">
                    üí° <span data-lang="suggestParameters">–ü—Ä–µ–¥–ª–æ–∂–∏ —Ç—Ä–∞–Ω–∑–∏—Å—Ç–æ—Ä–∏</span>
                </button>
            </div>
            
            <div id="parameterResults" class="results-display"></div>
        </div>
    </div>

    <!-- Utility Functions -->
    <div class="controls tool-section">
        <h2><span data-lang="utilityFunctionsTitle">üõ†Ô∏è –ü–æ–º–æ—â–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏</span></h2>
        <p><span data-lang="utilityFunctionsDescription">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –¥–∞–Ω–Ω–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ.</span></p>
        
        <div class="utility-functions">
            <div class="utility-grid">
                <div class="utility-section">
                    <h4>üóëÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –¥–∞–Ω–Ω–∏</h4>
                    <div class="button-row">
                        <button onclick="clearAllApplicationData()" class="utility-btn warning">
                            üóëÔ∏è <span data-lang="clearAllData">–ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏</span>
                        </button>
                        <button onclick="resetApplicationSettings()" class="utility-btn warning">
                            üîÑ <span data-lang="resetSettings">–í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </button>
                        <button onclick="clearApplicationCache()" class="utility-btn">
                            üßπ <span data-lang="clearCache">–ò–∑—á–∏—Å—Ç–∏ –∫–µ—à–∞</span>
                        </button>
                    </div>
                </div>
                
                <div class="utility-section">
                    <h4>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                    <div class="button-row">
                        <button onclick="exportApplicationSettings()" class="utility-btn">
                            üì§ <span data-lang="exportSettings">–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </button>
                        <button onclick="importApplicationSettings()" class="utility-btn">
                            üì• <span data-lang="importSettings">–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </button>
                    </div>
                </div>
                
                <div class="utility-section">
                    <h4>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                    <div class="button-row">
                        <button onclick="showApplicationInfo()" class="utility-btn info">
                            ‚ÑπÔ∏è <span data-lang="aboutApp">–ó–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ</span>
                        </button>
                        <button onclick="showVersionInfo()" class="utility-btn info">
                            üìã <span data-lang="versionInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≤–µ—Ä—Å–∏—è—Ç–∞</span>
                        </button>
                        <button onclick="showTechnicalSupport()" class="utility-btn info">
                            üõ†Ô∏è <span data-lang="technicalSupport">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞ –ø–æ–¥–¥—Ä—ä–∂–∫–∞</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status and Messages -->
    <div id="toolsMessages" class="tools-messages"></div>
</section>

<script>
// Initialize tools functionality when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeToolsPage();
    setupUnitConverters();
    setupCSVHandlers();
});

// Chart Export Functions
function exportChart(format) {
    const quality = document.getElementById('exportQuality').value;
    const statusEl = document.getElementById('chartExportStatus');
    
    try {
        // Find the most recent chart canvas from other pages
        const charts = document.querySelectorAll('canvas');
        let targetChart = null;
        
        // Look for Chart.js canvases or any chart canvas
        for (let chart of charts) {
            if (chart.id.includes('Chart') || chart.classList.contains('chart')) {
                targetChart = chart;
                break;
            }
        }
        
        if (!targetChart) {
            // Create a sample chart for demonstration
            createSampleChart();
            targetChart = document.getElementById('sampleChart');
        }
        
        if (format === 'png') {
            exportChartAsPNG(targetChart, quality);
        } else if (format === 'svg') {
            exportChartAsSVG(targetChart);
        }
        
        showStatus(statusEl, `Chart exported as ${format.toUpperCase()} with ${quality} DPI`, 'success');
    } catch (error) {
        console.error('Error exporting chart:', error);
        showStatus(statusEl, 'Error exporting chart', 'error');
    }
}

function exportChartAsPNG(canvas, dpi) {
    const scale = dpi / 96; // 96 DPI is standard screen resolution
    const width = canvas.width * scale;
    const height = canvas.height * scale;
    
    // Create a high-resolution canvas
    const hqCanvas = document.createElement('canvas');
    hqCanvas.width = width;
    hqCanvas.height = height;
    
    const ctx = hqCanvas.getContext('2d');
    ctx.scale(scale, scale);
    ctx.drawImage(canvas, 0, 0);
    
    // Download the image
    hqCanvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chart_${dpi}dpi_${new Date().getTime()}.png`;
        a.click();
        URL.revokeObjectURL(url);
    }, 'image/png');
}

function exportChartAsSVG(canvas) {
    // For SVG export, we would need access to the original chart data
    // This is a simplified implementation
    const svgContent = createSVGFromCanvas(canvas);
    const blob = new Blob([svgContent], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chart_${new Date().getTime()}.svg`;
    a.click();
    URL.revokeObjectURL(url);
}

function copyChartToClipboard() {
    const charts = document.querySelectorAll('canvas');
    const targetChart = charts[0] || createSampleChart();
    
    targetChart.toBlob(function(blob) {
        navigator.clipboard.write([
            new ClipboardItem({ 'image/png': blob })
        ]).then(() => {
            showMessage('Chart copied to clipboard!', 'success');
        }).catch(() => {
            showMessage('Failed to copy chart to clipboard', 'error');
        });
    });
}

// Unit Conversion Functions
function setupUnitConverters() {
    const converters = ['voltage', 'current', 'resistance', 'temperature'];
    
    converters.forEach(type => {
        const input = document.getElementById(type + 'Input');
        const fromSelect = document.getElementById(type + 'From');
        const toSelect = document.getElementById(type + 'To');
        
        if (input && fromSelect && toSelect) {
            [input, fromSelect, toSelect].forEach(el => {
                el.addEventListener('input', () => convertUnits(type));
                el.addEventListener('change', () => convertUnits(type));
            });
        }
    });
}

function convertUnits(type) {
    const input = document.getElementById(type + 'Input');
    const fromUnit = document.getElementById(type + 'From').value;
    const toUnit = document.getElementById(type + 'To').value;
    const resultEl = document.getElementById(type + 'Result');
    
    const value = parseFloat(input.value);
    if (isNaN(value)) {
        resultEl.textContent = '-';
        return;
    }
    
    let result;
    
    switch (type) {
        case 'voltage':
            result = convertVoltage(value, fromUnit, toUnit);
            break;
        case 'current':
            result = convertCurrent(value, fromUnit, toUnit);
            break;
        case 'resistance':
            result = convertResistance(value, fromUnit, toUnit);
            break;
        case 'temperature':
            result = convertTemperature(value, fromUnit, toUnit);
            break;
    }
    
    resultEl.textContent = formatNumber(result) + ' ' + toUnit;
}

function convertVoltage(value, from, to) {
    const toVolts = { 'V': 1, 'kV': 1000, 'mV': 0.001, 'ŒºV': 0.000001 };
    const volts = value * toVolts[from];
    return volts / toVolts[to];
}

function convertCurrent(value, from, to) {
    const toAmps = { 'A': 1, 'kA': 1000, 'mA': 0.001, 'ŒºA': 0.000001 };
    const amps = value * toAmps[from];
    return amps / toAmps[to];
}

function convertResistance(value, from, to) {
    const toOhms = { 'Œ©': 1, 'kŒ©': 1000, 'mŒ©': 0.001, 'MŒ©': 1000000 };
    const ohms = value * toOhms[from];
    return ohms / toOhms[to];
}

function convertTemperature(value, from, to) {
    let celsius;
    
    switch (from) {
        case '¬∞C': celsius = value; break;
        case 'K': celsius = value - 273.15; break;
        case '¬∞F': celsius = (value - 32) * 5/9; break;
    }
    
    switch (to) {
        case '¬∞C': return celsius;
        case 'K': return celsius + 273.15;
        case '¬∞F': return celsius * 9/5 + 32;
    }
}

function clearAllConversions() {
    ['voltage', 'current', 'resistance', 'temperature'].forEach(type => {
        document.getElementById(type + 'Input').value = '';
        document.getElementById(type + 'Result').textContent = '-';
    });
}

// CSV Import/Export Functions
function setupCSVHandlers() {
    const fileInput = document.getElementById('csvFileInput');
    if (fileInput) {
        fileInput.addEventListener('change', handleCSVImport);
    }
}

function handleCSVImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const data = parseCSV(csv);
            processImportedData(data);
            showMessage('CSV data imported successfully!', 'success');
        } catch (error) {
            showMessage('Error importing CSV data: ' + error.message, 'error');
        }
    };
    reader.readAsText(file);
}

function parseCSV(csv) {
    const lines = csv.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',').map(h => h.trim());
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        headers.forEach((header, index) => {
            row[header] = values[index];
        });
        data.push(row);
    }
    
    return data;
}

function processImportedData(data) {
    // Add imported transistors to the database
    console.log('Imported transistor data:', data);
    document.getElementById('csvImportStatus').innerHTML = 
        `<span class="success">Imported ${data.length} transistor records</span>`;
}

function exportCalculationsToCSV() {
    try {
        const data = collectCalculationData();
        const csv = convertToCSV(data);
        downloadFile(csv, 'calculations.csv', 'text/csv');
        showMessage('Calculations exported to CSV', 'success');
    } catch (error) {
        showMessage('Error exporting to CSV: ' + error.message, 'error');
    }
}

function exportCalculationsToPDF() {
    try {
        showMessage('PDF export functionality would be implemented here', 'info');
    } catch (error) {
        showMessage('Error exporting to PDF: ' + error.message, 'error');
    }
}

// Parameter Calculator Functions
function calculateOptimalParameters() {
    const power = parseFloat(document.getElementById('targetPower').value);
    const voltage = parseFloat(document.getElementById('targetVoltage').value);
    const current = parseFloat(document.getElementById('targetCurrent').value);
    
    if (isNaN(power) || isNaN(voltage) || isNaN(current)) {
        showMessage('Please enter valid power, voltage, and current values', 'error');
        return;
    }
    
    const results = {
        recommendedFsw: calculateOptimalFrequency(power, voltage),
        recommendedDuty: calculateOptimalDuty(power, voltage, current),
        thermalRequirements: calculateThermalRequirements(power),
        efficiency: calculateExpectedEfficiency(power, voltage, current)
    };
    
    displayParameterResults(results);
}

function suggestTransistors() {
    const power = parseFloat(document.getElementById('targetPower').value);
    const voltage = parseFloat(document.getElementById('targetVoltage').value);
    const current = parseFloat(document.getElementById('targetCurrent').value);
    
    const suggestions = findOptimalTransistors(power, voltage, current);
    displayTransistorSuggestions(suggestions);
}

function calculateOptimalFrequency(power, voltage) {
    // Simplified algorithm - in reality this would be more complex
    if (voltage > 600) return '20-50 kHz';
    if (voltage > 200) return '50-100 kHz';
    return '100-200 kHz';
}

function calculateOptimalDuty(power, voltage, current) {
    return 0.5; // Simplified - typically 50% for symmetric operation
}

function calculateThermalRequirements(power) {
    if (power > 100) return 'Forced air cooling required';
    if (power > 50) return 'Medium heatsink recommended';
    return 'Natural cooling sufficient';
}

function calculateExpectedEfficiency(power, voltage, current) {
    // Simplified efficiency calculation
    return (95 - power / 100).toFixed(1) + '%';
}

// Utility Functions
function clearAllApplicationData() {
    if (confirm('Are you sure you want to clear all application data? This cannot be undone.')) {
        localStorage.clear();
        sessionStorage.clear();
        showMessage('All application data cleared', 'success');
    }
}

function resetApplicationSettings() {
    if (confirm('Reset all settings to default values?')) {
        // Reset form values
        document.querySelectorAll('input, select').forEach(el => {
            if (el.type === 'number') el.value = '';
            else if (el.type === 'select-one') el.selectedIndex = 0;
        });
        showMessage('Settings reset to defaults', 'success');
    }
}

function clearApplicationCache() {
    if ('caches' in window) {
        caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
        });
    }
    showMessage('Application cache cleared', 'success');
}

function exportApplicationSettings() {
    const settings = collectApplicationSettings();
    const json = JSON.stringify(settings, null, 2);
    downloadFile(json, 'app_settings.json', 'application/json');
}

function importApplicationSettings() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    applyApplicationSettings(settings);
                    showMessage('Settings imported successfully', 'success');
                } catch (error) {
                    showMessage('Error importing settings: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
    };
    input.click();
}

function showApplicationInfo() {
    const info = `
        <h3>Si/SiC/GaN Transistor Calculator</h3>
        <p><strong>Version:</strong> 2.1 Scientific Edition</p>
        <p><strong>Description:</strong> Professional engineering calculator for Si/SiC/GaN transistor analysis</p>
        <p><strong>Features:</strong></p>
        <ul>
            <li>Comprehensive loss calculations</li>
            <li>Advanced thermal modeling</li>
            <li>Multi-technology comparison</li>
            <li>Professional chart export</li>
            <li>Unit conversion tools</li>
        </ul>
        <p><strong>Copyright:</strong> ¬© 2025 Scientific Calculator App</p>
    `;
    showModal('Application Information', info);
}

function showVersionInfo() {
    const versionInfo = `
        <h3>Version Information</h3>
        <p><strong>Version:</strong> 2.1.0</p>
        <p><strong>Build Date:</strong> ${new Date().toLocaleDateString()}</p>
        <p><strong>Environment:</strong> Production</p>
        <p><strong>Features:</strong></p>
        <ul>
            <li>Chart export with 300 DPI support</li>
            <li>Comprehensive unit converter</li>
            <li>CSV import/export functionality</li>
            <li>Parameter optimization tools</li>
            <li>Multi-language support (BG/EN)</li>
        </ul>
    `;
    showModal('Version Information', versionInfo);
}

function showTechnicalSupport() {
    const supportInfo = `
        <h3>Technical Support</h3>
        <p><strong>For technical support, please provide:</strong></p>
        <ul>
            <li>Browser version and operating system</li>
            <li>Steps to reproduce the issue</li>
            <li>Expected vs actual behavior</li>
            <li>Any error messages</li>
        </ul>
        <p><strong>Known Issues:</strong></p>
        <ul>
            <li>Chart export requires modern browser support</li>
            <li>Large CSV files may take time to process</li>
            <li>PDF export requires additional libraries</li>
        </ul>
        <p><strong>Browser Compatibility:</strong> Chrome 80+, Firefox 75+, Safari 13+, Edge 80+</p>
    `;
    showModal('Technical Support', supportInfo);
}

// Helper Functions
function initializeToolsPage() {
    // Initialize the tools page with proper language support
    if (typeof switchLanguage === 'function') {
        // Apply current language if language switching is available
        const currentLang = localStorage.getItem('preferred-language') || 'bg';
        // Don't call switchLanguage here to avoid conflicts
    }
}

function createSampleChart() {
    // Create a sample chart canvas for demonstration
    const canvas = document.createElement('canvas');
    canvas.id = 'sampleChart';
    canvas.width = 400;
    canvas.height = 300;
    const ctx = canvas.getContext('2d');
    
    // Draw a simple sample chart
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(0, 0, 400, 300);
    ctx.fillStyle = '#333';
    ctx.font = '16px Arial';
    ctx.fillText('Sample Chart', 150, 150);
    
    return canvas;
}

function createSVGFromCanvas(canvas) {
    return `<svg width="${canvas.width}" height="${canvas.height}" xmlns="http://www.w3.org/2000/svg">
        <image href="${canvas.toDataURL()}" width="${canvas.width}" height="${canvas.height}"/>
    </svg>`;
}

function formatNumber(num) {
    if (Math.abs(num) >= 1000000) return (num / 1000000).toFixed(2) + 'M';
    if (Math.abs(num) >= 1000) return (num / 1000).toFixed(2) + 'k';
    if (Math.abs(num) < 0.001) return num.toExponential(2);
    return num.toFixed(4);
}

function collectCalculationData() {
    return [{
        timestamp: new Date().toISOString(),
        technology: 'Sample',
        power: 100,
        efficiency: 95.5,
        losses: 4.5
    }];
}

function convertToCSV(data) {
    if (!data.length) return '';
    const headers = Object.keys(data[0]);
    const csvContent = [headers.join(',')];
    data.forEach(row => {
        csvContent.push(headers.map(header => row[header] || '').join(','));
    });
    return csvContent.join('\n');
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function collectApplicationSettings() {
    const settings = {};
    document.querySelectorAll('input, select').forEach(el => {
        if (el.id) settings[el.id] = el.value;
    });
    return settings;
}

function applyApplicationSettings(settings) {
    Object.keys(settings).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = settings[id];
    });
}

function findOptimalTransistors(power, voltage, current) {
    // This would search the TRANSISTOR_DB for optimal matches
    return [
        { name: 'IRF540N', match: '85%', reason: 'Good voltage rating match' },
        { name: 'IRFZ44N', match: '78%', reason: 'Low RDS(on) for current' },
        { name: 'STB80NF55', match: '92%', reason: 'Optimal for automotive use' }
    ];
}

function displayParameterResults(results) {
    const resultsEl = document.getElementById('parameterResults');
    resultsEl.innerHTML = `
        <h4>Recommended Parameters:</h4>
        <div class="param-result">
            <strong>Switching Frequency:</strong> ${results.recommendedFsw}
        </div>
        <div class="param-result">
            <strong>Duty Cycle:</strong> ${results.recommendedDuty}
        </div>
        <div class="param-result">
            <strong>Thermal Requirements:</strong> ${results.thermalRequirements}
        </div>
        <div class="param-result">
            <strong>Expected Efficiency:</strong> ${results.efficiency}
        </div>
    `;
}

function displayTransistorSuggestions(suggestions) {
    const resultsEl = document.getElementById('parameterResults');
    let html = '<h4>Recommended Transistors:</h4>';
    suggestions.forEach(s => {
        html += `
            <div class="transistor-suggestion">
                <strong>${s.name}</strong> - ${s.match} match
                <br><small>${s.reason}</small>
            </div>
        `;
    });
    resultsEl.innerHTML = html;
}

function showStatus(element, message, type) {
    element.innerHTML = `<span class="${type}">${message}</span>`;
    setTimeout(() => element.innerHTML = '', 5000);
}

function showMessage(message, type) {
    const messagesEl = document.getElementById('toolsMessages');
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.textContent = message;
    messagesEl.appendChild(div);
    setTimeout(() => div.remove(), 5000);
}

function showModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>${title}</h3>
                <button onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body">${content}</div>
        </div>
    `;
    document.body.appendChild(modal);
}
</script>
{% endblock %}